machine:
  environment:
    CLOUDSDK_INSTALL_DIR: /home/ubuntu
    CLOUDSDK_CORE_DISABLE_PROMPTS: 1
    GOOGLE_SECRET_FILE: /tmp/google_secret.json

  services:
    - docker

dependencies:
  override:
    - curl https://sdk.cloud.google.com | bash
    - echo "source '/home/ubuntu/google-cloud-sdk/path.bash.inc'" >> /home/ubuntu/.circlerc

test:
  pre:
    - echo $google_secret > $GOOGLE_SECRET_FILE
    - gcloud auth activate-service-account --key-file $GOOGLE_SECRET_FILE

  override:
    - gcloud --version

deployment:
  gcr:
    branch: gcr-example
    commands:
      - docker build -t asia.gcr.io/circleci-gcr-example/circle-test  .
      - gcloud docker push asia.gcr.io/circleci-gcr-example/circle-test
